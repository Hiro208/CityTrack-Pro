# backend/.env Required Guide

This guide explains which environment variables are required, which are optional, and common startup/runtime errors.

## Quick Copy

Create local env file from template:

```bash
cp backend/.env.example backend/.env
```

Then fill values in `backend/.env`.

---

## Variable Matrix

| Key | Required | Default | Example | Notes |
|---|---|---|---|---|
| `PORT` | No | `5001` | `5001` | Backend HTTP port |
| `NODE_ENV` | No | `development` | `development` | One of `development`, `production`, `test` |
| `DB_USER` | Yes | - | `postgres` | PostgreSQL username |
| `DB_PASSWORD` | Yes | - | `your_password` | PostgreSQL password |
| `DB_NAME` | Yes | - | `transit_analytics` | Database name |
| `DB_HOST` | Yes | - | `localhost` | Database host |
| `DB_PORT` | Yes | - | `5432` | Database port (number) |
| `REDIS_HOST` | No | `localhost` | `localhost` | Redis host |
| `REDIS_PORT` | No | `6379` | `6379` | Redis port (number) |
| `JWT_SECRET` | No (but strongly recommended) | `change-me-in-production` | `a-long-random-secret` | Must be replaced in non-local environments |
| `SMTP_HOST` | No | empty | `smtp.gmail.com` | Needed only for email notifications |
| `SMTP_PORT` | No | empty | `465` or `587` | Use provider-recommended port |
| `SMTP_USER` | No | empty | `your_mail@example.com` | SMTP account |
| `SMTP_PASS` | No | empty | `app_password` | SMTP password/app password |
| `SMTP_FROM` | No | empty | `Transit Alerts <no-reply@example.com>` | Sender name + address |
| `VAPID_PUBLIC_KEY` | No | empty | - | Legacy field; not required for current email-only flow |
| `VAPID_PRIVATE_KEY` | No | empty | - | Legacy field; not required for current email-only flow |
| `VAPID_SUBJECT` | No | `mailto:admin@example.com` | `mailto:ops@example.com` | Legacy field; not required for current email-only flow |

---

## Minimal Local Setup

If you only want core app + auth + favorites (without email sending), these keys are enough:

```env
PORT=5001
NODE_ENV=development
DB_USER=postgres
DB_PASSWORD=your_password
DB_NAME=transit_analytics
DB_HOST=localhost
DB_PORT=5432
REDIS_HOST=localhost
REDIS_PORT=6379
JWT_SECRET=replace_with_a_strong_secret
```

## Enable Email Notifications

Add SMTP keys:

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=465
SMTP_USER=your_email@example.com
SMTP_PASS=your_app_password
SMTP_FROM=Transit Alerts <your_email@example.com>
```

---

## Common Errors and Fixes

### 1) `环境变量校验失败`
- Cause: required keys missing or invalid type.
- Fix: check `DB_*` fields first, then `DB_PORT`/`REDIS_PORT` numeric values.

### 2) `Database connection failed` on `/health`
- Cause: Postgres not running, wrong host/port/user/password/dbname.
- Fix:
  - verify postgres service status
  - verify `DB_HOST`, `DB_PORT`
  - verify credentials and db exists

### 3) App starts but no email sent
- Cause: SMTP not configured or account blocks auth.
- Fix:
  - set all `SMTP_*` values
  - use app password for providers that require it
  - verify `SMTP_FROM` matches sender policy

### 4) `mail domain not found` / domain lookup error
- Cause: malformed recipient address (e.g., missing `.com`).
- Fix: validate full email format before submitting.

### 5) Cannot login after changing `JWT_SECRET`
- Cause: old tokens become invalid.
- Fix: clear browser local storage and login again.

---

## Security Checklist (Before Sharing Repository)

1. Keep `.env` untracked (already covered by `.gitignore`).
2. Never paste real credentials into docs/screenshots.
3. Rotate SMTP app password before interviews/demo if it was previously exposed.
4. Replace `JWT_SECRET` with strong random value in any deployed environment.

---

## SMTP Credential Rotation (Recommended)

Use your email provider security console to create a new SMTP app password and revoke the old one.

Suggested sequence:
1. Generate new SMTP app password in provider console.
2. Update local `backend/.env` `SMTP_PASS`.
3. Restart backend and send a test notification.
4. Revoke old SMTP password/token.

